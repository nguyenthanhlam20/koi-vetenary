@model IEnumerable<KoiVetenary.Data.Models.MedicalRecord>

@{
    ViewData["Title"] = "Index";
}

<h1>Index</h1>

@*  <p>
     <a asp-action="Create">Create New</a>
 </p>
 <table class="table">
     <thead>
         <tr>
             <th>
                 @Html.DisplayNameFor(model => model.RecordDate)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.Symptoms)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.Diagnosis)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.Treatment)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.Medications)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.LabResults)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.VetNotes)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.FollowUpRequired)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.FollowUpDate)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.CreatedBy)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.ModifiedBy)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.CreatedDate)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.UpdatedDate)
             </th>
             <th>
                 @Html.DisplayNameFor(model => model.Animal)
             </th>
             <th></th>
         </tr>
     </thead>
     <tbody>
 @foreach (var item in Model) {
         <tr>
             <td>
                 @Html.DisplayFor(modelItem => item.RecordDate)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.Symptoms)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.Diagnosis)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.Treatment)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.Medications)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.LabResults)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.VetNotes)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.FollowUpRequired)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.FollowUpDate)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.CreatedBy)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.ModifiedBy)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.CreatedDate)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.UpdatedDate)
             </td>
             <td>
                 @Html.DisplayFor(modelItem => item.Animal.Name)
             </td>
             <td>
                 <a asp-action="Edit" asp-route-id="@item.RecordId">Edit</a> |
                 <a asp-action="Details" asp-route-id="@item.RecordId">Details</a> |
                 <a asp-action="Delete" asp-route-id="@item.RecordId">Delete</a>
             </td>
         </tr>
 }
     </tbody>
 </table> *@

<div class="row">
    <div class="col-md-12">
        <button onclick="window.location.href='/MedicalRecords/Create'" class="btn btn-success mb-3">Create New</button>

         <!-- Search Bar -->
        <div class="mb-3">
            <input type="text" id="searchTerm" class="form-control" placeholder="Search Medical Records...">
            <button onclick="searchData()" class="btn btn-primary mt-2">Search</button>
        </div>


        <table class="table table-striped table-bordered table-hover">
            <thead>
                <tr class="card-header">
                    <th class="card-title text-center">Record Date</th>
                    <th class="card-title text-center">Symptoms</th>
                    <th class="card-title text-center">Diagnosis</th>
                    <th class="card-title text-center">Treatment</th>
                    <th class="card-title text-center">Medications</th>
                    <th class="card-title text-center">Lab Results</th>
                    <th class="card-title text-center">Vet Notes</th>
                    <th class="card-title text-center">Follow Up Required</th>
                    <th class="card-title text-center">Follow Up Date</th>
                    <th class="card-title text-center">Created By</th>
                    <th class="card-title text-center">Modified By</th>
                    <th class="card-title text-center">Created Date</th>
                    <th class="card-title text-center">Updated Date</th>
                    <th class="card-title text-center">Animal Name</th>
                    <th class="card-title text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="tblMedicalRecords">
            </tbody>
        </table>
    </div>
</div>

@* @section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            loadData();
        });

        function loadData() {
            $.ajax({
                url: 'https://localhost:7238/api/MedicalRecord',
                type: "GET",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    console.log(result);
                    var html = '';
                    $.each(result.data, function (key, item) {
                        html += '<tr>';
                        html += '<td>' + formatDate(item.recordDate) + '</td>';
                        html += '<td>' + item.symptoms + '</td>';
                        html += '<td>' + item.diagnosis + '</td>';
                        html += '<td>' + item.treatment + '</td>';
                        html += '<td>' + item.medications + '</td>';
                        html += '<td>' + item.labResults + '</td>';
                        html += '<td>' + item.vetNotes + '</td>';
                        html += '<td>' + item.followUpRequired + '</td>';
                        html += '<td>' + formatDate(item.followUpDate) + '</td>';
                        html += '<td>' + item.createdBy + '</td>';
                        html += '<td>' + item.modifiedBy + '</td>';
                        html += '<td>' + formatDate(item.createdDate) + '</td>';
                        html += '<td>' + formatDate(item.updatedDate) + '</td>';
                        html += '<td>' + (item.animal ? item.animal.name : '') + '</td>';
                        html += '<td>';
                        html += '<a href="/MedicalRecords/Edit/' + item.recordId + '">Edit</a> | ';
                        html += '<a href="/MedicalRecords/Details/' + item.recordId + '">Details</a> | ';
                        html += '<a href="/MedicalRecords/Delete/' + item.recordId + '">Delete</a>';
                        html += '</td>';
                        html += '</tr>';
                    });
                    $('.tblMedicalRecords').html(html);
                },
                error: function (xhr, error) {
                    alert('Error: ' + xhr.statusText);
                }
            });
        }

        function formatDate(dateString) {
            if (dateString) {
                var date = new Date(dateString);
                return date.toLocaleDateString();
            } else {
                return '';
            }
        }
    </script>
} *@

@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            loadData(); // Load all records when the page is first loaded
        });

        // Function to load all data
        function loadData() {
            $.ajax({
                url: 'https://localhost:7238/api/MedicalRecord',
                type: "GET",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    renderTable(result.data);
                },
                error: function (xhr, error) {
                    alert('Error: ' + xhr.statusText);
                }
            });
        }

        // Function to handle the search
        function searchData() {
            var searchTerm = $('#searchTerm').val().trim(); // Get the value of the search term and trim any spaces
            var url = 'https://localhost:7238/api/MedicalRecord';

            // If search term is not empty, append it to the search API call
            if (searchTerm !== '') {
                url = url + '/search?searchTerm=' + encodeURIComponent(searchTerm);
            }

            // Make AJAX call to fetch records based on search term or all records if searchTerm is empty
            $.ajax({
                url: url,
                type: "GET",
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (result) {
                    renderTable(result.data); // Render the search results or all records
                },
                error: function (xhr, error) {
                    alert('Error: ' + xhr.statusText);
                }
            });
        }

        // Function to render the table rows with results
        function renderTable(data) {
            var html = '';
            $.each(data, function (key, item) {
                html += '<tr>';
                html += '<td>' + formatDate(item.recordDate) + '</td>';
                html += '<td>' + item.symptoms + '</td>';
                html += '<td>' + item.diagnosis + '</td>';
                html += '<td>' + item.treatment + '</td>';
                html += '<td>' + item.medications + '</td>';
                html += '<td>' + item.labResults + '</td>';
                html += '<td>' + item.vetNotes + '</td>';
                html += '<td>' + item.followUpRequired + '</td>';
                html += '<td>' + formatDate(item.followUpDate) + '</td>';
                html += '<td>' + item.createdBy + '</td>';
                html += '<td>' + item.modifiedBy + '</td>';
                html += '<td>' + formatDate(item.createdDate) + '</td>';
                html += '<td>' + formatDate(item.updatedDate) + '</td>';
                html += '<td>' + (item.animal ? item.animal.name : '') + '</td>';
                html += '<td>';
                html += '<a href="/MedicalRecords/Edit/' + item.recordId + '">Edit</a> | ';
                html += '<a href="/MedicalRecords/Details/' + item.recordId + '">Details</a> | ';
                html += '<a href="/MedicalRecords/Delete/' + item.recordId + '">Delete</a>';
                html += '</td>';
                html += '</tr>';
            });
            $('.tblMedicalRecords').html(html);
        }

        // Helper function to format dates
        function formatDate(dateString) {
            if (dateString) {
                var date = new Date(dateString);
                return date.toLocaleDateString();
            } else {
                return '';
            }
        }
    </script>
}
